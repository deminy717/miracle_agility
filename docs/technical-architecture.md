# Miracle Agility 技术架构文档

## 架构概览
Miracle Agility 是基于微信小程序原生框架开发的犬敏捷训练平台，采用前后端分离的架构设计，前端负责用户界面和交互，后端提供数据服务和业务逻辑。

## 技术选型

### 前端技术栈
- **开发框架**: 微信小程序原生框架
- **编程语言**: JavaScript (ES6+)
- **样式语言**: WXSS (微信样式表)
- **模板语言**: WXML (微信标记语言)
- **构建工具**: 微信开发者工具
- **版本控制**: Git

### 后端技术栈（预期）
- **服务端语言**: Node.js / Python / Java（可选）
- **数据库**: MySQL / MongoDB
- **缓存**: Redis
- **文件存储**: 腾讯云COS / 阿里云OSS
- **API框架**: Express.js / Koa.js / Spring Boot

### 开发工具
- **IDE**: 微信开发者工具、VS Code、WebStorm、Cursor
- **调试工具**: 微信开发者工具调试面板
- **版本管理**: Git + GitHub/GitLab
- **项目管理**: 敏捷开发方法

## 系统架构

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序     │    │   API网关        │    │   业务服务       │
│                │    │                │    │                │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ 页面层     │  │    │  │ 路由转发   │  │    │  │ 用户服务   │  │
│  │ Pages     │  │◄──►│  │ 认证鉴权   │  │◄──►│  │ 课程服务   │  │
│  └───────────┘  │    │  │ 限流熔断   │  │    │  │ 内容服务   │  │
│  ┌───────────┐  │    │  └───────────┘  │    │  │ 文件服务   │  │
│  │ 组件层     │  │    └─────────────────┘    │  └───────────┘  │
│  │ Components│  │                          │                │
│  └───────────┘  │    ┌─────────────────┐    │  ┌───────────┐  │
│  ┌───────────┐  │    │   数据存储       │    │  │ 统计服务   │  │
│  │ 工具层     │  │    │                │    │  │ 推荐服务   │  │
│  │ Utils     │  │    │  ┌───────────┐  │    │  │ 通知服务   │  │
│  └───────────┘  │    │  │ MySQL     │  │    │  └───────────┘  │
└─────────────────┘    │  │ Redis     │  │    └─────────────────┘
                       │  │ 文件存储   │  │
                       │  └───────────┘  │
                       └─────────────────┘
```

### 前端架构层次

#### 1. 应用层 (App Layer)
- **文件**: `app.js`, `app.json`, `app.wxss`
- **职责**: 
  - 应用生命周期管理
  - 全局配置和样式
  - 全局数据存储
  - 页面路由配置

#### 2. 页面层 (Page Layer)
- **目录**: `pages/`
- **职责**:
  - 页面逻辑处理
  - 用户交互响应
  - 数据展示和绑定
  - 页面生命周期管理

#### 3. 组件层 (Component Layer)
- **说明**: 目前使用微信小程序内置组件，未来可扩展自定义组件
- **职责**:
  - 可复用的UI组件
  - 业务逻辑封装
  - 组件间通信

#### 4. 工具层 (Utils Layer)
- **目录**: `utils/`
- **职责**:
  - API接口封装
  - 通用工具函数
  - 配置管理
  - Mock数据处理

#### 5. 静态资源层 (Static Layer)
- **目录**: `static/`
- **职责**:
  - 图片资源管理
  - 图标资源管理
  - 其他静态文件

## 数据流架构

### 数据流向图
```
用户操作 → 页面事件 → 业务逻辑 → API调用 → 后端服务 → 数据库
    ↑                                                      ↓
页面更新 ← 数据绑定 ← 状态更新 ← 响应处理 ← API响应 ← 业务处理
```

### 状态管理
1. **全局状态**: 存储在 `app.js` 的 `globalData` 中
2. **页面状态**: 存储在各页面的 `data` 对象中
3. **本地存储**: 使用 `wx.storage` API 持久化数据

### 数据持久化策略
- **用户信息**: 本地存储 + 服务端同步
- **学习进度**: 实时同步到服务端
- **缓存数据**: 本地存储，定期更新
- **临时数据**: 页面级存储，页面销毁时清除

## 核心模块设计

### 1. 用户模块
**文件位置**: 分布在多个页面和工具函数中

**核心功能**:
- 微信登录授权
- 用户信息管理
- 学习统计展示
- 权限控制

**数据流**:
```
微信授权 → 获取code → 服务端验证 → 返回token → 本地存储
```

### 2. 内容模块
**文件位置**: `pages/article-*`, `pages/home/`

**核心功能**:
- 文章列表展示
- 文章详情查看
- 文章搜索筛选
- 文章互动（点赞、收藏、分享）

**数据流**:
```
页面加载 → API请求 → 数据处理 → 页面渲染 → 用户交互 → 状态更新
```

### 3. 课程模块
**文件位置**: `pages/course*`

**核心功能**:
- 课程列表浏览
- 课程详情查看
- 课程内容学习
- 学习进度跟踪

**数据流**:
```
课程选择 → 权限验证 → 内容加载 → 进度记录 → 成就解锁
```

### 4. 编辑器模块
**文件位置**: `pages/rich-text-editor/`, `pages/card-editor/`

**核心功能**:
- 富文本编辑
- 媒体文件处理
- 内容预览
- 内容发布

**数据流**:
```
内容输入 → 格式处理 → 媒体上传 → 内容保存 → 发布审核
```

### 5. 管理模块
**文件位置**: `pages/admin/`

**核心功能**:
- 内容管理
- 用户管理
- 数据统计
- 系统配置

**数据流**:
```
管理操作 → 权限验证 → 业务处理 → 数据更新 → 结果反馈
```

## API设计架构

### RESTful API设计
- **资源导向**: 以资源为中心设计API
- **HTTP方法**: 使用标准HTTP方法（GET、POST、PUT、DELETE）
- **状态码**: 使用标准HTTP状态码
- **统一响应**: 统一的响应格式和错误处理

### API分层架构
```
┌─────────────────┐
│   控制器层       │ ← 处理HTTP请求，参数验证
│   Controller    │
├─────────────────┤
│   服务层         │ ← 业务逻辑处理，事务管理
│   Service       │
├─────────────────┤
│   数据访问层     │ ← 数据库操作，缓存管理
│   Repository    │
├─────────────────┤
│   数据模型层     │ ← 数据结构定义，关系映射
│   Model         │
└─────────────────┘
```

### API安全设计
- **认证机制**: JWT Token认证
- **权限控制**: 基于角色的访问控制（RBAC）
- **数据加密**: HTTPS传输，敏感数据加密
- **防护措施**: 限流、防刷、参数校验

## 性能优化策略

### 前端性能优化
1. **代码分割**: 按页面分割代码，懒加载
2. **资源优化**: 图片压缩，图标字体化
3. **缓存策略**: 合理使用本地缓存
4. **网络优化**: 请求合并，数据预加载

### 后端性能优化
1. **数据库优化**: 索引优化，查询优化
2. **缓存策略**: Redis缓存热点数据
3. **CDN加速**: 静态资源CDN分发
4. **负载均衡**: 多实例部署，负载分散

### 用户体验优化
1. **加载优化**: 骨架屏，渐进式加载
2. **交互优化**: 防抖节流，即时反馈
3. **错误处理**: 友好的错误提示
4. **离线支持**: 关键功能离线可用

## 安全架构

### 前端安全
- **数据验证**: 客户端输入验证
- **敏感信息**: 避免在客户端存储敏感数据
- **代码混淆**: 生产环境代码混淆
- **版本控制**: 及时更新修复安全漏洞

### 后端安全
- **输入验证**: 严格的参数校验
- **SQL注入**: 使用参数化查询
- **XSS防护**: 输出转义，CSP策略
- **CSRF防护**: Token验证机制

## 部署架构

### 开发环境
- **本地开发**: 微信开发者工具 + Mock数据
- **热更新**: 实时预览和调试
- **版本控制**: Git分支管理

### 测试环境
- **自动化测试**: 单元测试，集成测试
- **性能测试**: 压力测试，性能监控
- **兼容性测试**: 多设备，多版本测试

### 生产环境
- **容器化部署**: Docker容器部署
- **自动化部署**: CI/CD流水线
- **监控告警**: 系统监控，日志分析
- **备份恢复**: 数据备份，灾难恢复

## 扩展性设计

### 水平扩展
- **微服务架构**: 服务拆分，独立部署
- **数据库分片**: 数据水平分割
- **缓存集群**: Redis集群部署
- **负载均衡**: 多实例负载分发

### 垂直扩展
- **服务器升级**: CPU、内存、存储升级
- **数据库优化**: 索引优化，查询优化
- **代码优化**: 算法优化，性能调优

## 监控和运维

### 系统监控
- **服务监控**: 服务可用性，响应时间
- **资源监控**: CPU、内存、磁盘、网络
- **业务监控**: 用户行为，业务指标
- **错误监控**: 异常捕获，错误统计

### 日志管理
- **日志收集**: 统一日志收集
- **日志分析**: 实时日志分析
- **日志存储**: 日志持久化存储
- **日志查询**: 快速日志检索

### 运维自动化
- **自动部署**: 一键部署发布
- **自动扩容**: 根据负载自动扩容
- **自动恢复**: 故障自动恢复
- **配置管理**: 统一配置管理

## 技术演进规划

### 短期规划（1-3个月）
- 完善核心功能开发
- 优化用户体验
- 增强系统稳定性
- 完善测试覆盖

### 中期规划（3-6个月）
- 引入自定义组件
- 实现离线功能
- 优化性能表现
- 扩展业务功能

### 长期规划（6个月以上）
- 微服务架构改造
- 大数据分析平台
- AI智能推荐
- 多端适配扩展

## 开发规范

### 代码规范
- **命名规范**: 驼峰命名，语义化命名
- **注释规范**: 关键逻辑必须注释
- **文件组织**: 按功能模块组织文件
- **代码复用**: 提取公共函数和组件

### Git规范
- **分支策略**: GitFlow工作流
- **提交规范**: 规范化提交信息
- **代码审查**: Pull Request审查
- **版本管理**: 语义化版本号

### 文档规范
- **API文档**: 详细的接口文档
- **代码文档**: 代码注释和说明
- **部署文档**: 部署和运维文档
- **用户文档**: 用户使用指南

## 错误处理架构

### 统一错误处理机制
项目采用统一的错误处理机制，通过 `utils/errorHandler.js` 模块集中处理各种错误类型，确保用户体验的一致性。

#### 错误处理分层
```
┌─────────────────┐
│   页面层错误     │ ← 页面特定的错误处理逻辑
│   Page Errors   │
├─────────────────┤
│   业务层错误     │ ← API调用、文件上传等业务错误
│   Business Errors│
├─────────────────┤
│   网络层错误     │ ← HTTP状态码、网络连接错误
│   Network Errors│
├─────────────────┤
│   系统层错误     │ ← 微信小程序系统级错误
│   System Errors │
└─────────────────┘
```

#### HTTP状态码处理策略

| 状态码 | 处理策略 | 用户体验 |
|--------|----------|----------|
| 401 | 清除登录信息，跳转到个人中心登录界面 | 自动跳转，提示重新登录 |
| 403 | 显示权限不足模态框 | 红色确认按钮，明确权限提示 |
| 404 | 显示资源不存在提示 | Toast提示，3秒消失 |
| 500 | 显示服务器错误提示 | Toast提示，建议稍后重试 |
| 502/503/504 | 显示服务不可用提示 | Toast提示，服务暂时不可用 |

#### 业务错误码处理

| 错误码 | 错误类型 | 处理策略 |
|--------|----------|----------|
| 401 | 认证失败 | 同HTTP 401 |
| 403 | 权限不足 | 同HTTP 403 |
| 1001 | 参数错误 | Toast提示，2秒消失 |
| 1002 | 数据不存在 | Toast提示，2秒消失 |
| 其他 | 业务异常 | 显示具体错误信息 |

#### 错误处理组件

**核心模块**: `utils/errorHandler.js`

主要功能：
- `handleHttpError()` - HTTP状态码错误处理
- `handleBusinessError()` - 业务错误码处理
- `handleNetworkError()` - 网络错误处理
- `isAuthError()` - 认证错误检查
- `isPermissionError()` - 权限错误检查

**集成模块**:
- `utils/api.js` - API请求错误处理
- `utils/upload.js` - 文件上传错误处理
- 各页面的业务逻辑 - 特定错误处理

#### 使用示例

```javascript
// 在API请求中使用
try {
  const result = await api.getCourseList()
  // 处理成功结果
} catch (error) {
  const errorHandler = require('../utils/errorHandler.js')
  
  if (errorHandler.isAuthError(error)) {
    // 401错误已自动处理，无需额外操作
    return
  }
  
  if (errorHandler.isPermissionError(error)) {
    // 403错误已自动处理，无需额外操作
    return
  }
  
  // 处理其他错误
  console.error('操作失败:', error.message)
}
```

#### 错误日志记录
所有错误都会在控制台中详细记录，包括：
- 错误类型和状态码
- 错误消息和堆栈
- 请求URL和参数
- 用户操作上下文

#### 用户体验优化
- **自动跳转**: 401错误自动跳转到登录页面，无需用户手动操作
- **权限提示**: 403错误显示清晰的权限不足说明
- **操作反馈**: 所有错误都有相应的用户反馈
- **重试机制**: 网络错误提供重试建议
- **优雅降级**: 上传失败时保留本地文件，支持重试

这个技术架构文档为Miracle Agility项目提供了全面的技术指导，涵盖了从前端到后端、从开发到部署的各个方面，为项目的健康发展奠定了坚实的技术基础。 