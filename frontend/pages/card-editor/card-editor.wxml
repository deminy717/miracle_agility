<!--å¡ç‰‡å¼å†…å®¹ç¼–è¾‘å™¨-->
<view class="card-editor-container">

  <!-- è¯¾æ—¶åˆ›å»ºä¿¡æ¯ -->
  <view class="lesson-create-info" wx:if="{{editorType === 'lesson'}}">
    <view class="section-header">
      <text class="section-title">è¯¾æ—¶åŸºæœ¬ä¿¡æ¯</text>
      <text class="chapter-name">ç« èŠ‚ï¼š{{chapterTitle}}</text>
    </view>
    <view class="form-group">
      <text class="form-label">è¯¾æ—¶æ ‡é¢˜ *</text>
      <input class="form-input lesson-title" 
             placeholder="è¯·è¾“å…¥è¯¾æ—¶æ ‡é¢˜ï¼ˆä¾‹å¦‚ï¼š2.1 çŠ¬æ•æ·åŸºç¡€åŠ¨ä½œè®­ç»ƒï¼‰" 
             value="{{lessonInfo.title}}" 
             bindinput="onLessonTitleInput"
             maxlength="50"/>
    </view>
    <view class="form-group">
      <text class="form-label">è¯¾æ—¶ç®€ä»‹ *</text>
      <textarea class="form-textarea lesson-description" 
                placeholder="è¯·ç®€è¦æè¿°æœ¬è¯¾æ—¶çš„å­¦ä¹ å†…å®¹å’Œç›®æ ‡ï¼ˆ50-300å­—ï¼‰" 
                value="{{lessonInfo.description}}" 
                bindinput="onLessonDescriptionInput"
                maxlength="300"
                show-confirm-bar="{{false}}">
      </textarea>
    </view>

  </view>

  <!-- è¯¾ç¨‹ä¿¡æ¯ -->
  <view class="course-info" wx:if="{{editorType !== 'chapter' && editorType !== 'lesson'}}">
    <input class="course-title" 
           placeholder="è¯·è¾“å…¥è¯¾ç¨‹æ ‡é¢˜" 
           value="{{courseInfo.title}}" 
           bindinput="onTitleInput"/>
    <input class="course-subtitle" 
           placeholder="è¯·è¾“å…¥ç« èŠ‚ä¿¡æ¯" 
           value="{{courseInfo.subtitle}}" 
           bindinput="onSubtitleInput"/>
  </view>

  <!-- ç« èŠ‚åˆ›å»ºä¿¡æ¯ -->
  <view class="chapter-info" wx:if="{{editorType === 'chapter'}}">
    <view class="section-header">
      <text class="section-title">ç« èŠ‚åŸºæœ¬ä¿¡æ¯</text>
      <text class="course-name">è¯¾ç¨‹ï¼š{{courseName}}</text>
    </view>
    <view class="form-group">
      <text class="form-label">ç« èŠ‚æ ‡é¢˜ *</text>
      <input class="form-input chapter-title" 
             placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜ï¼ˆä¾‹å¦‚ï¼šç¬¬ä¸€ç«  çŠ¬æ•æ·åŸºç¡€æ¦‚å¿µï¼‰" 
             value="{{chapterInfo.title}}" 
             bindinput="onChapterTitleInput"
             maxlength="50"/>
    </view>
    <view class="form-group">
      <text class="form-label">ç« èŠ‚æè¿° *</text>
      <textarea class="form-textarea chapter-description" 
                placeholder="è¯·ç®€è¦æè¿°æœ¬ç« èŠ‚çš„å­¦ä¹ å†…å®¹å’Œç›®æ ‡ï¼ˆ50-200å­—ï¼‰" 
                value="{{chapterInfo.description}}" 
                bindinput="onChapterDescriptionInput"
                maxlength="200"
                show-confirm-bar="{{false}}">
      </textarea>
    </view>
  </view>

  <!-- å†…å®¹å¡ç‰‡ -->
  <scroll-view class="content-scroll" scroll-y>
    <view class="content-cards">
      <view class="content-card" wx:for="{{contentCards}}" wx:key="id">
        
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <view class="card-header">
          <view class="card-type {{item.type}}">{{item.typeName}}</view>
          <view class="card-actions">
            <text class="action-btn" bindtap="moveUp" data-index="{{index}}">â†‘</text>
            <text class="action-btn" bindtap="moveDown" data-index="{{index}}">â†“</text>
            <text class="action-btn delete" bindtap="deleteCard" data-index="{{index}}">Ã—</text>
          </view>
        </view>

        <!-- è§†é¢‘å¡ç‰‡ -->
        <view wx:if="{{item.type === 'video'}}" class="video-content">
          <view wx:if="{{item.videoUrl}}" class="video-preview">
            <video src="{{item.videoUrl}}" controls class="video-player"></video>
            <view class="video-stats">
              <text>ğŸ¬ {{item.duration || '30åˆ†é’Ÿ'}}</text>
              <view wx:if="{{item.fileSize}}" class="file-size">ğŸ“¦ {{item.fileSize}}</view>
            </view>
            <!-- ä¸Šä¼ å¤±è´¥æç¤º -->
            <view wx:if="{{item.uploadFailed}}" class="upload-error">
              <text class="error-icon">âš ï¸</text>
              <text class="error-text">ä¸Šä¼ å¤±è´¥: {{item.errorMessage}}</text>
              <text class="retry-btn" bindtap="retryUpload" data-index="{{index}}" data-type="video">é‡è¯•</text>
            </view>
          </view>
          <view wx:else class="video-placeholder" bindtap="selectVideo" data-index="{{index}}">
            <text class="placeholder-icon">ğŸ“¹</text>
            <text>ç‚¹å‡»æ·»åŠ è§†é¢‘</text>
          </view>
        </view>

        <!-- æ–‡æœ¬å¡ç‰‡ -->
        <view wx:elif="{{item.type === 'text'}}" class="text-content">
          <input placeholder="æ®µè½æ ‡é¢˜" 
                 value="{{item.title}}"
                 bindinput="onTextTitleInput"
                 data-index="{{index}}"
                 class="text-title"/>
          <textarea placeholder="è¯·è¾“å…¥æ–‡æœ¬å†…å®¹..." 
                    value="{{item.content}}"
                    bindinput="onTextContentInput"
                    data-index="{{index}}"
                    class="text-area">
          </textarea>
        </view>

        <!-- å›¾ç‰‡å¡ç‰‡ -->
        <view wx:elif="{{item.type === 'image'}}" class="image-content">
          <view wx:if="{{item.imageUrl}}" class="image-preview">
            <image src="{{item.imageUrl}}" mode="aspectFill" class="image-display"></image>
            <view class="image-info">
              <text class="change-image-btn" bindtap="selectImage" data-index="{{index}}">æ›´æ¢å›¾ç‰‡</text>
              <view wx:if="{{item.fileSize}}" class="file-size">ğŸ“¦ {{item.fileSize}}</view>
            </view>
            <!-- ä¸Šä¼ å¤±è´¥æç¤º -->
            <view wx:if="{{item.uploadFailed}}" class="upload-error">
              <text class="error-icon">âš ï¸</text>
              <text class="error-text">ä¸Šä¼ å¤±è´¥: {{item.errorMessage}}</text>
              <text class="retry-btn" bindtap="retryUpload" data-index="{{index}}" data-type="image">é‡è¯•</text>
            </view>
          </view>
          <view wx:else class="image-placeholder" bindtap="selectImage" data-index="{{index}}">
            <text class="placeholder-icon">ğŸ–¼ï¸</text>
            <text>ç‚¹å‡»æ·»åŠ å›¾ç‰‡</text>
          </view>
          <textarea placeholder="å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰" 
                    value="{{item.description}}"
                    bindinput="onImageDescriptionInput"
                    data-index="{{index}}"
                    class="image-description">
          </textarea>
        </view>

        <!-- é‡ç‚¹å¡ç‰‡ -->
        <view wx:elif="{{item.type === 'highlight'}}" class="highlight-content">
          <input placeholder="é‡ç‚¹æ ‡é¢˜" 
                 value="{{item.title}}"
                 bindinput="onHighlightTitleInput"
                 data-index="{{index}}"
                 class="highlight-title"/>
          <view class="highlight-points">
            <view wx:for="{{item.points}}" wx:key="pointIndex" wx:for-item="point" wx:for-index="pointIndex" class="point-item">
              <text class="point-bullet">â€¢</text>
              <input placeholder="é‡ç‚¹å†…å®¹" 
                     value="{{point}}"
                     bindinput="onPointInput"
                     data-index="{{index}}"
                     data-point-index="{{pointIndex}}"
                     class="point-input"/>
              <text class="delete-point" 
                    bindtap="deletePoint" 
                    data-index="{{index}}" 
                    data-point-index="{{pointIndex}}">Ã—</text>
            </view>
            <text class="add-point" bindtap="addPoint" data-index="{{index}}">+ æ·»åŠ é‡ç‚¹</text>
          </view>
        </view>

      </view>
    </view>
  </scroll-view>

  <!-- æ·»åŠ æŒ‰é’® -->
  <view class="add-fab" bindtap="showAddMenu">+</view>

  <!-- æ·»åŠ èœå• -->
  <view class="add-menu {{showAddMenu ? 'show' : ''}}" wx:if="{{showAddMenu}}">
    <view class="menu-overlay" bindtap="hideAddMenu"></view>
    <view class="menu-content">
      <text class="menu-title">é€‰æ‹©å†…å®¹ç±»å‹</text>
      <view class="menu-options">
        <view class="menu-option" bindtap="addCard" data-type="video">
          <text class="option-icon">ğŸ“¹</text>
          <text>è§†é¢‘</text>
        </view>
        <view class="menu-option" bindtap="addCard" data-type="text">
          <text class="option-icon">ğŸ“</text>
          <text>æ–‡æœ¬</text>
        </view>
        <view class="menu-option" bindtap="addCard" data-type="image">
          <text class="option-icon">ğŸ–¼ï¸</text>
          <text>å›¾ç‰‡</text>
        </view>
        <view class="menu-option" bindtap="addCard" data-type="highlight">
          <text class="option-icon">âš¡</text>
          <text>é‡ç‚¹</text>
        </view>
      </view>
    </view>
  </view>

  <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
  <view class="preview-modal {{showPreview ? 'show' : ''}}" wx:if="{{showPreview}}">
    <view class="preview-content">
      <view class="preview-header">
        <text class="preview-title">è¯¾æ—¶é¢„è§ˆ</text>
        <text class="close-btn" bindtap="closePreview">Ã—</text>
      </view>
      <scroll-view class="preview-body" scroll-y>
        <!-- è¯¾æ—¶æ ‡é¢˜å’Œæè¿° -->
        <view class="preview-lesson-header" wx:if="{{editorType === 'lesson'}}">
          <text class="preview-lesson-title">{{lessonInfo.title || 'æœªè®¾ç½®æ ‡é¢˜'}}</text>
          <text class="preview-lesson-description">{{lessonInfo.description || 'æœªè®¾ç½®æè¿°'}}</text>
                     <view class="preview-lesson-meta">
             <text class="meta-item" wx:if="{{lessonInfo.typeIndex !== -1}}">
               ğŸ·ï¸ {{lessonTypes[lessonInfo.typeIndex]}}
             </text>

             <text class="meta-item" wx:if="{{lessonInfo.levelIndex !== -1}}">
               ğŸ“Š {{lessonLevels[lessonInfo.levelIndex]}}
             </text>
           </view>
        </view>

        <!-- ç« èŠ‚æ ‡é¢˜å’Œæè¿° -->
        <view class="preview-chapter-header" wx:elif="{{editorType === 'chapter'}}">
          <text class="preview-chapter-title">{{chapterInfo.title || 'æœªè®¾ç½®æ ‡é¢˜'}}</text>
          <text class="preview-chapter-description">{{chapterInfo.description || 'æœªè®¾ç½®æè¿°'}}</text>
        </view>

        <!-- è¯¾ç¨‹æ ‡é¢˜å’Œæè¿° -->
        <view class="preview-course-header" wx:else>
          <text class="preview-course-title">{{courseInfo.title || 'æœªè®¾ç½®æ ‡é¢˜'}}</text>
          <text class="preview-course-subtitle">{{courseInfo.subtitle || 'æœªè®¾ç½®å‰¯æ ‡é¢˜'}}</text>
        </view>

        <!-- å†…å®¹åŒºåŸŸ -->
        <view class="preview-content-area">
          <view wx:for="{{contentCards}}" wx:key="id" class="preview-section">
            
            <!-- æ–‡æœ¬å†…å®¹ -->
            <view wx:if="{{item.type === 'text'}}" class="preview-text-section">
              <text wx:if="{{item.title}}" class="section-title">{{item.title}}</text>
              <text class="section-content">{{item.content}}</text>
            </view>
            
            <!-- å›¾ç‰‡å†…å®¹ -->
            <view wx:elif="{{item.type === 'image' && item.imageUrl}}" class="preview-image-section">
              <image src="{{item.imageUrl}}" mode="widthFix" class="section-image"></image>
              <text wx:if="{{item.description}}" class="image-caption">{{item.description}}</text>
            </view>
            
            <!-- è§†é¢‘å†…å®¹ -->
            <view wx:elif="{{item.type === 'video' && item.videoUrl}}" class="preview-video-section">
              <video src="{{item.videoUrl}}" controls class="section-video" poster="{{item.thumbnail}}"></video>
              <view class="video-info">
                <text class="video-duration">ğŸ¬ {{item.duration || 'æ’­æ”¾æ—¶é•¿æœªçŸ¥'}}</text>
              </view>
            </view>
            
            <!-- é‡ç‚¹å†…å®¹ -->
            <view wx:elif="{{item.type === 'highlight'}}" class="preview-highlight-section">
              <text wx:if="{{item.title}}" class="highlight-section-title">{{item.title}}</text>
              <view class="highlight-box">
                <view wx:for="{{item.points}}" wx:key="pointIndex" wx:for-item="point" class="highlight-point">
                  <text class="point-marker">ğŸ’¡</text>
                  <text class="point-text">{{point}}</text>
                </view>
              </view>
            </view>

            <!-- éŸ³é¢‘å†…å®¹ -->
            <view wx:elif="{{item.type === 'audio' && item.audioUrl}}" class="preview-audio-section">
              <view class="audio-player">
                <text class="audio-icon">ğŸµ</text>
                <text class="audio-title">{{item.title || 'éŸ³é¢‘å†…å®¹'}}</text>
                <text class="audio-duration">{{item.duration || 'æ—¶é•¿æœªçŸ¥'}}</text>
              </view>
            </view>

            <!-- æµ‹éªŒå†…å®¹ -->
            <view wx:elif="{{item.type === 'quiz'}}" class="preview-quiz-section">
              <view class="quiz-box">
                <text class="quiz-icon">â“</text>
                <text class="quiz-title">{{item.title || 'äº’åŠ¨æµ‹éªŒ'}}</text>
                <text class="quiz-description">ç‚¹å‡»å¼€å§‹ç­”é¢˜</text>
              </view>
            </view>

            <!-- ç©ºå†…å®¹æç¤º -->
            <view wx:else class="preview-empty-section">
              <text class="empty-text">å†…å®¹ä¸ºç©ºæˆ–ç±»å‹ä¸æ”¯æŒé¢„è§ˆ</text>
            </view>

          </view>

          <!-- æ— å†…å®¹æç¤º -->
          <view wx:if="{{contentCards.length === 0}}" class="preview-no-content">
            <text class="no-content-icon">ğŸ“</text>
            <text class="no-content-text">æš‚æ— å†…å®¹ï¼Œè¯·æ·»åŠ å­¦ä¹ ææ–™</text>
          </view>
        </view>

        <!-- é¢„è§ˆåº•éƒ¨ä¿¡æ¯ -->
        <view class="preview-footer">
          <text class="footer-info">é¢„è§ˆæ¨¡å¼ - ä»¥ä¸Šä¸ºè¯¾æ—¶å†…å®¹æ•ˆæœå±•ç¤º</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è°ƒè¯•æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
  <view class="debug-log-section" wx:if="{{showDebugLog}}">
    <view class="debug-header" bindtap="toggleDebugLog">
      <text class="debug-title">ğŸ› è°ƒè¯•æ—¥å¿—</text>
      <text class="debug-toggle">{{debugLogExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
    </view>
    <scroll-view class="debug-log-content {{debugLogExpanded ? 'expanded' : ''}}" scroll-y scroll-top="{{debugLogs.length * 30}}">
      <view wx:for="{{debugLogs}}" wx:key="index" class="debug-log-item">
        <text class="debug-log-text">{{item}}</text>
      </view>
      <view wx:if="{{debugLogs.length === 0}}" class="debug-log-empty">
        <text>æš‚æ— è°ƒè¯•æ—¥å¿—</text>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨å·¥å…·æ  -->
  <view class="bottom-toolbar">
    <button class="toolbar-btn" bindtap="showPreview">é¢„è§ˆ</button>
    <button class="toolbar-btn" bindtap="clearAll">æ¸…ç©º</button>
    <button class="toolbar-btn draft" bindtap="saveDraft" wx:if="{{editorType === 'lesson' && !editMode}}">ä¿å­˜è‰ç¨¿</button>
    <button class="toolbar-btn primary" bindtap="saveContent">{{editMode ? (editorType === 'lesson' ? 'æ›´æ–°è¯¾æ—¶' : 'æ›´æ–°å†…å®¹') : (editorType === 'lesson' ? 'åˆ›å»ºè¯¾æ—¶' : editorType === 'chapter' ? 'åˆ›å»ºç« èŠ‚' : 'ä¿å­˜')}}</button>
  </view>
</view>
